name: Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: melihemreguler/portfolio

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NEXT_PUBLIC_EMAILJS_PUBLIC_KEY=${{ secrets.NEXT_PUBLIC_EMAILJS_PUBLIC_KEY }}
          NEXT_PUBLIC_EMAILJS_SERVICE_ID=${{ secrets.NEXT_PUBLIC_EMAILJS_SERVICE_ID }}
          NEXT_PUBLIC_EMAILJS_TEMPLATE_ID=${{ secrets.NEXT_PUBLIC_EMAILJS_TEMPLATE_ID }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.K8S_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.K8S_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Kubernetes
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.K8S_USERNAME }}@${{ secrets.K8S_HOST }} << 'EOF'
          echo "Starting Kubernetes deployment..."

          # System telemetry
          echo "System Information:"
          echo "OS: $(uname -s -r)"
          echo "Uptime: $(uptime -p)"

          # Memory telemetry
          echo "Memory Usage:"
          free -h | awk 'NR==2{printf "• RAM: %s used / %s total (%.1f%%)\n", $3, $2, $3*100/$2}'

          # Disk telemetry
          echo "Disk Usage:"
          df -h / | awk 'NR==2{printf "• Root: %s used / %s total (%s)\n", $3, $2, $5}'

          # Kubernetes validation and installation
          echo "Kubernetes Validation:"
          if ! command -v kubectl &> /dev/null; then
            echo "• kubectl not found, installing..."

            # Install kubectl
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/

            # Verify installation
            if kubectl version --client &> /dev/null; then
              echo "• kubectl installed successfully"
            else
              echo "• CRITICAL: kubectl installation failed!"
              exit 1
            fi
          else
            echo "• kubectl is available"
            kubectl version --client --short 2>/dev/null || kubectl version --client
          fi

          # Project directory setup
          echo "Project Setup:"
          mkdir -p /root/portfolio-k8s
          cd /root/portfolio-k8s
          echo "Project directory ready"

          # Download/update Kubernetes manifests
          echo "Configuration Update:"
          curl -s -o deployment.yaml https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/k8s/deployment.yaml
          if [ -f deployment.yaml ]; then
            echo "deployment.yaml updated"
          else
            echo "Failed to download deployment.yaml"
            exit 1
          fi

          # Apply Kubernetes manifests
          echo "Kubernetes Deployment:"

          # Create namespace if not exists
          kubectl create namespace portfolio --dry-run=client -o yaml | kubectl apply -f -
          echo "• Namespace 'portfolio' ready"

          # Create Docker Hub secret if not exists
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKER_USERNAME }} \
            --docker-password=${{ secrets.DOCKER_PASSWORD }} \
            --namespace=portfolio \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "• Docker Hub secret configured"

          # Apply deployment
          kubectl apply -f deployment.yaml
          echo "• Deployment manifest applied"

          # Wait for rollout
          echo "• Waiting for deployment rollout..."
          kubectl rollout status deployment/portfolio-web -n portfolio --timeout=300s

          # Force pods to pull new image
          kubectl rollout restart deployment/portfolio-web -n portfolio
          echo "• Deployment restarted to pull latest image"

          # Wait for new rollout
          kubectl rollout status deployment/portfolio-web -n portfolio --timeout=300s

          # Deployment health validation
          echo "Health Check:"

          # Wait a bit for old pods to terminate
          sleep 5

          # Get actual running and ready pods count
          RUNNING_PODS=$(kubectl get pods -n portfolio -l app=portfolio-web --field-selector=status.phase=Running --no-headers 2>/dev/null | grep -c "1/1")
          TOTAL_PODS=$(kubectl get deployment portfolio-web -n portfolio -o jsonpath='{.spec.replicas}' 2>/dev/null)

          echo "• Running & Ready Pods: $RUNNING_PODS/$TOTAL_PODS"

          if [ "$RUNNING_PODS" -ge "$TOTAL_PODS" ] && [ "$RUNNING_PODS" -gt 0 ]; then
            echo "✓ All pods are running successfully"

            # Show pod details
            echo "Pod Details:"
            kubectl get pods -n portfolio -l app=portfolio-web -o wide

            # Show resource usage
            echo "Resource Usage:"
            kubectl top pods -n portfolio -l app=portfolio-web 2>/dev/null || echo "• Metrics unavailable (metrics-server may not be installed)"

            # Show service and ingress
            echo "Service Information:"
            kubectl get svc -n portfolio
            echo "Ingress Information:"
            kubectl get ingress -n portfolio

          else
            echo "• Deployment failed - not enough pods are ready"
            echo "Pod Status:"
            kubectl get pods -n portfolio -l app=portfolio-web
            echo "Recent Events:"
            kubectl get events -n portfolio --sort-by='.lastTimestamp' | tail -10
            echo "Pod Logs:"
            kubectl logs -n portfolio -l app=portfolio-web --tail=50 --all-containers=true
            exit 1
          fi

          # Clean up old replica sets
          echo "Cleanup:"
          kubectl delete replicaset -n portfolio $(kubectl get replicaset -n portfolio -o jsonpath='{.items[?(@.spec.replicas==0)].metadata.name}') 2>/dev/null || echo "• No old replica sets to clean"

          # Final status
          echo "Final Status:"
          echo "• Deployment: $(kubectl get deployment portfolio-web -n portfolio -o jsonpath='{.status.conditions[?(@.type=="Available")].status}')"
          echo "• Image: $(kubectl get deployment portfolio-web -n portfolio -o jsonpath='{.spec.template.spec.containers[0].image}')"
          echo "• Replicas: $(kubectl get deployment portfolio-web -n portfolio -o jsonpath='{.status.readyReplicas}')/$TOTAL_PODS"

          echo "Deployment completed successfully!"
          echo "Application available at: https://melihemre.dev"
        EOF

    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key
